<?xml version="1.0" encoding="UTF-8"?><SQLQuery AllowBuffering="false" AllowFuture="true" AutoTypeParameters="false" CacheDuration="0" CacheDurationUnits="M" Columns="" Comment="" Connector="" DateColumn="" DateFormat="MM/dd/yyyy HH:mm:ss" Debug="false" Description="" DocType="SQLQuery" Duration="60" DurationUnits="M" EndDate="" FilterExpr="" FixedQuery="" Group="" GroupingExpr="" ID="263918" InlineTransform="" IntervalCount="1" IsCachable="false" JoinExpr="" Mask="" Method="" Mode="Command" NumberFormat="0.00" Param.1="2024-07-16 00:00:00.000" Param.10="" Param.11="" Param.12="" Param.13="" Param.14="" Param.15="" Param.16="" Param.17="" Param.18="" Param.19="" Param.2="2024-07-16 23:59:59.000" Param.20="" Param.21="" Param.22="" Param.23="" Param.24="" Param.25="" Param.26="" Param.27="" Param.28="" Param.29="" Param.3="" Param.30="" Param.31="" Param.32="" Param.4="" Param.5="" Param.6="" Param.7="" Param.8="" Param.9="" ParamDescription.1="" ParamDescription.10="" ParamDescription.11="" ParamDescription.12="" ParamDescription.13="" ParamDescription.14="" ParamDescription.15="" ParamDescription.16="" ParamDescription.17="" ParamDescription.18="" ParamDescription.19="" ParamDescription.2="" ParamDescription.20="" ParamDescription.21="" ParamDescription.22="" ParamDescription.23="" ParamDescription.24="" ParamDescription.25="" ParamDescription.26="" ParamDescription.27="" ParamDescription.28="" ParamDescription.29="" ParamDescription.3="" ParamDescription.30="" ParamDescription.31="" ParamDescription.32="" ParamDescription.4="" ParamDescription.5="" ParamDescription.6="" ParamDescription.7="" ParamDescription.8="" ParamDescription.9="" ParamType.1="" ParamType.10="" ParamType.11="" ParamType.12="" ParamType.13="" ParamType.14="" ParamType.15="" ParamType.16="" ParamType.17="" ParamType.18="" ParamType.19="" ParamType.2="" ParamType.20="" ParamType.21="" ParamType.22="" ParamType.23="" ParamType.24="" ParamType.25="" ParamType.26="" ParamType.27="" ParamType.28="" ParamType.29="" ParamType.3="" ParamType.30="" ParamType.31="" ParamType.32="" ParamType.4="" ParamType.5="" ParamType.6="" ParamType.7="" ParamType.8="" ParamType.9="" Password="" PathID="1165" Query="set NOCOUNT on&#10;declare &#10;@StartTime datetime,&#10;@EndTime datetime&#10;&#10;&#10;&#10;set @StartTime= '[Param.1]',&#10;&#9;@EndTime=  '[Param.2]'&#10;&#9;&#10;--SELECT @StartTime, @EndTime&#10;&#10;DELETE FROM EST.dbo.HIST_PRODUCTIVITY_OPERATION &#10;where CONF_TIME = @StartTime&#10;&#10;----MII DATALARI----&#10;&#10;SELECT  &#10;cast(T3.[OPER_ID] as int) OPER_ID, &#10;T3.SNAME, &#10;T3.MACHINE_ID,&#10;0 OFFTIME,&#10;0 PREPTIME, &#10;0 UPTIME,&#10;0 PLANNED_DOWN, &#10;0 UNPLANNED_DOWN,&#10;ISNULL(SUM(LOGON_DURATION),0) LOGON_DURATION,&#10;ISNULL(SUM(MACHINE_CNT_CYCLE)/60,0) MACHINE_CNT_CYCLE&#10;into #TempTable1&#10;FROM (&#10;&#9;&#9;---------------3-------------------&#10;&#9;&#9;SELECT&#10;&#9;&#9;&#9;T2.[OPER_ID],&#10;&#9;&#9;&#9;T2.SNAME,&#10;&#9;&#9;&#9;T2.[MACHINE_ID],&#10;&#9;&#9;&#9;([LOGON_TIME]) LOGON_TIME,&#10;&#9;&#9;&#9;([LOGOFF_TIME]) LOGOFF_TIME,&#10;&#9;&#9;&#9;SUM(LOGON_DURATION) LOGON_DURATION,&#10;            SUM(MACHINE_CNT_CYCLE) MACHINE_CNT_CYCLE&#10;&#9;&#9;FROM&#10;&#9;&#9;&#9;(&#10;&#9;&#9;&#9;---------------4------------&#10;&#9;&#9;&#9;SELECT&#10;&#9;&#9;&#9;&#9;[OPER_ID],&#10;&#9;&#9;&#9;&#9;SNAME,&#10;&#9;&#9;&#9;&#9;[MACHINE_ID],&#10;&#9;&#9;&#9;&#9;[LOGON_TIME],&#10;&#9;&#9;&#9;&#9;[LOGOFF_TIME],&#10;&#9;&#9;&#9;&#9;CASE&#10;         &#9;&#9;when &#10;         &#9;&#9;MACHINE_ID&lt;1000&#10;        &#9;&#9;then&#10;        &#9;&#9;[MACHINE_CNT_CYCLE] ELSE 0 END MACHINE_CNT_CYCLE,&#10;        &#9;&#9;CASE&#10;         &#9;&#9;when &#10;         &#9;&#9;RBT_EYE=0&#10;        &#9;&#9;then&#10;&#9;&#9;&#9;&#9;sum(cast ( cast(datediff(minute, [LOGON_TIME], [LOGOFF_TIME] ) as DECIMAL(8, 2)) as DECIMAL(8, 1))) &#10;&#9;&#9;&#9;&#9;else 0 end &#10;&#9;&#9;&#9;&#9;LOGON_DURATION&#10;        &#9;&#9;FROM&#10;&#9;&#9;&#9;&#9;HIST_OPERATOR_LOGON&#10;&#9;&#9;&#9;where&#10;&#9;&#9;&#9;&#9;(LOGON_TIME between  dateadd(mi,-3,@StartTime) and @EndTime&#10;&#9;&#9;&#9;&#9;&#9;or LOGOFF_TIME between @StartTime and @EndTime&#10;&#9;&#9;&#9;&#9;&#9;or (LOGON_TIME &lt;  dateadd(mi,-3,@StartTime)&#10;&#9;&#9;&#9;&#9;&#9;&#9;and LOGOFF_TIME &gt; @EndTime)&#10;          )&#10;          &#10;        &#10;&#9;&#9;&#9;&#9;AND [OPER_ID] IN (SELECT OPER_ID FROM EST.dbo.CNFG_OPERATOR) &#10;&#9;&#9;&#9;group by&#10;&#9;&#9;&#9;&#9;[OPER_ID],&#10;&#9;&#9;&#9;&#9;SNAME,&#10;&#9;&#9;&#9;&#9;[MACHINE_ID] ,&#10;&#9;&#9;&#9;&#9;[LOGON_TIME],&#10;&#9;&#9;&#9;&#9;[LOGOFF_TIME]&#10;&#9;&#9;&#9;&#9;&#10;&#9;&#9;&#9;----------------4------------------&#9;&#10;        )T2&#10;GROUP BY&#10;&#9;&#9;&#9;T2.[OPER_ID],&#10;&#9;&#9;&#9;T2.[MACHINE_ID],&#10;&#9;&#9;&#9;LOGON_TIME,&#10;&#9;&#9;&#9;LOGOFF_TIME&#10;-----------3-----------&#10; &#10;  )T3&#10;  &#10;    GROUP BY T3.[OPER_ID], T3.SNAME ,T3.MACHINE_ID&#10;    &#10;  ----MII DATALARI----  &#10;&#10;   -- SELECT * FROM  #TempTable1&#10;    &#10;    &#10;    SELECT&#10;    [OPER_ID],&#10;    T3.[MACHINE_ID],&#10;    sum(case when T3.PRD_STEP = 0 then datediff(minute, case when T3.START_TIME &lt; T3.LOGON_TIME then T3.LOGON_TIME else T3.START_TIME end,&#10;  case when T3.END_TIME &gt; T3.LOGOFF_TIME or T3.END_TIME is null then T3.LOGOFF_TIME else T3.END_TIME end) end) &quot;OFFTIME&quot;,&#10;&#9;sum(case when T3.PRD_STEP = 1 then datediff(minute, case when T3.START_TIME &lt; T3.LOGON_TIME then T3.LOGON_TIME else T3.START_TIME end,&#10;  case when T3.END_TIME &gt; T3.LOGOFF_TIME or T3.END_TIME is null then T3.LOGOFF_TIME else T3.END_TIME end) end) &quot;PREPTIME&quot;,&#10;&#9;sum(case when T3.STATUS = 1 then datediff(minute, case when T3.START_TIME &lt; T3.LOGON_TIME then T3.LOGON_TIME else T3.START_TIME end,&#10;  case when T3.END_TIME &gt; T3.LOGOFF_TIME or T3.END_TIME is null then T3.LOGOFF_TIME else T3.END_TIME end) end) &quot;UPTIME&quot;,&#10;&#9;sum(case when (T3.PRD_STEP = 2 or T3.PRD_STEP = 3) AND T3.STATUS = 0 AND T3.PLANNED = 1 then datediff(minute, case when T3.START_TIME &lt; T3.LOGON_TIME then T3.LOGON_TIME else T3.START_TIME end,&#10;  case when T3.END_TIME &gt; T3.LOGOFF_TIME or T3.END_TIME is null then T3.LOGOFF_TIME else T3.END_TIME end) end) &quot;PLANNED_DOWN&quot;,&#10;&#9;sum(case when (T3.PRD_STEP = 2 or T3.PRD_STEP = 3) AND T3.STATUS = 0 AND T3.PLANNED = 0 then datediff(minute, case when T3.START_TIME &lt; T3.LOGON_TIME then T3.LOGON_TIME else T3.START_TIME end,&#10;  case when T3.END_TIME &gt; T3.LOGOFF_TIME or T3.END_TIME is null then T3.LOGOFF_TIME else T3.END_TIME end) end) &quot;UNPLANNED_DOWN&quot;&#10;into #TempTable2&#10;  &#9;FROM&#10;&#9;(&#10;    SELECT&#10;&#9;&#9;T1.[OPER_ID],&#10;&#9;&#9;T1.SNAME,&#10;&#9;&#9;T1.[MACHINE_ID],&#10;&#9;&#9;T1.[LOGON_TIME],&#10;&#9;&#9;T1.[LOGOFF_TIME],&#10;&#9;&#9;down.[MACHINE_ID],&#10;&#9;&#9;down.[START_TIME] START_TIME,&#10;&#9;&#9;down.[END_TIME] END_TIME,&#10;&#9;&#9;down.STATUS,&#10;&#9;&#9;down.[REASON_ID],&#10;&#9;&#9;down.[INSERT_BY],&#10;&#9;&#9;down.PRD_STEP,&#10;&#9;&#9;reas.PLANNED&#10;&#9;FROM&#10;&#9;&#9;(&#10;&#9;&#9;&#9;&#9;SELECT&#10;&#9;&#9;&#9;&#9;[OPER_ID],&#10;&#9;&#9;&#9;&#9;SNAME,&#10;&#9;&#9;&#9;&#9;[MACHINE_ID],&#10;&#9;&#9;&#9;&#9;[LOGON_TIME],&#10;&#9;&#9;&#9;&#9;[LOGOFF_TIME]&#9;&#9;&#9;&#9;&#10;        &#9;&#9;FROM&#10;&#9;&#9;&#9;&#9;HIST_OPERATOR_LOGON &#10;&#9;&#9;&#9;where&#10;&#9;&#9;&#9;&#9;(LOGON_TIME between dateadd(mi,-3,@StartTime) and @EndTime&#10;&#9;&#9;&#9;&#9;&#9;or LOGOFF_TIME between @StartTime and @EndTime&#10;&#9;&#9;&#9;&#9;&#9;or (LOGON_TIME &lt; dateadd(mi,-3,@StartTime)&#10;&#9;&#9;&#9;&#9;&#9;&#9;and LOGOFF_TIME &gt; @EndTime)&#10;          )&#10;&#9;&#9;&#9;&#9;AND [OPER_ID] IN (SELECT OPER_ID FROM  #TempTable1) &#10;&#9;&#9;&#9;&#9;and [MACHINE_ID] &lt;1000&#10;&#9;&#9;&#9;group by&#10;&#9;&#9;&#9;&#9;[OPER_ID],&#10;&#9;&#9;&#9;&#9;SNAME,&#10;&#9;&#9;&#9;&#9;[MACHINE_ID] ,&#10;&#9;&#9;&#9;&#9;[LOGON_TIME],&#10;&#9;&#9;&#9;&#9;[LOGOFF_TIME]&#10;&#9;&#9;&#10;&#9;&#9;) T1&#10;    left JOIN [HIST_DOWNTIME] down ON &#10;&#9;T1.[MACHINE_ID] = down.[MACHINE_ID]&#10;&#9;&#10;&#9;and (down.START_TIME between T1.LOGON_TIME and T1.LOGOFF_TIME&#10;&#9;or down.END_TIME between T1.LOGON_TIME and T1.LOGOFF_TIME&#10;&#9;or (down.START_TIME &lt; T1.LOGON_TIME&#10;&#9;&#9;and down.END_TIME &gt; T1.LOGOFF_TIME)&#10;&#9;or (down.END_TIME &gt; T1.LOGON_TIME&#10;&#9;&#9;and T1.LOGOFF_TIME is null)&#10;      )&#10;&#9;left JOIN [CNFG_DOWNTIME_REASON] reas ON&#10;&#9;&#9;down.[REASON_ID] = reas.[ID]&#10;&#10;&#9;GROUP BY&#10;&#9;&#9;T1.[OPER_ID],&#10;&#9;&#9;T1.SNAME,&#10;&#9;&#9;T1.[MACHINE_ID],&#10;&#9;&#9;T1.[LOGON_TIME],&#10;&#9;&#9;T1.[LOGOFF_TIME],&#10;&#9;&#9;down.[MACHINE_ID],&#10;&#9;&#9;down.[START_TIME],&#10;&#9;&#9;down.[END_TIME],&#10;&#9;&#9;down.STATUS,&#10;&#9;&#9;down.[REASON_ID],&#10;&#9;&#9;down.[INSERT_BY],&#10;&#9;&#9;down.PRD_STEP,&#10;&#9;&#9;reas.PLANNED&#10;---------2-----------&#10;    &#10;)T3&#10;  &#10;  GROUP BY [OPER_ID],T3.[MACHINE_ID]&#10;&#10;--SELECT * FROM  #TempTable2&#10;&#10;&#10;UPDATE #TempTable1   SET &#10;OFFTIME= ISNULL(new1.OFFTIME,0)  ,&#10;PREPTIME= ISNULL(new1.PREPTIME,0),  &#10;UPTIME= ISNULL(new1.UPTIME,0),&#10;PLANNED_DOWN= ISNULL(new1.PLANNED_DOWN,0),&#10;UNPLANNED_DOWN= ISNULL(new1.UNPLANNED_DOWN,0)&#10;from #TempTable1 old1 , #TempTable2 new1&#10;WHERE  old1.OPER_ID=new1.OPER_ID&#10;and old1.MACHINE_ID=new1.MACHINE_ID&#10;&#10;--SELECT * FROM  #TempTable1&#10;&#10;INSERT INTO EST.dbo.HIST_PRODUCTIVITY_OPERATION&#10;(&#10;OPER_ID, &#10;MACHINE_ID,&#10;CONF_TIME, &#10;SNAME, &#10;OFFTIME, &#10;PREPTIME, &#10;UPTIME, &#10;PLANNED_DOWN, &#10;UNPLANNED_DOWN, &#10;LOGON_DURATION, &#10;MACHINE_CNT_CYCLE, &#10;NON_LOGON_DURATION, &#10;NON_PRODUCTION_DURATION)&#10;SELECT &#10;OPER_ID, &#10;MACHINE_ID,&#10;@StartTime , &#10;SNAME, &#10;OFFTIME, &#10;PREPTIME, &#10;UPTIME, &#10;PLANNED_DOWN, &#10;UNPLANNED_DOWN, &#10;LOGON_DURATION, &#10;MACHINE_CNT_CYCLE, &#10;0,&#10;0&#10;FROM  #TempTable1&#10;&#10;drop table  #TempTable1&#10;drop table  #TempTable2&#10;" QueryParams="" ReaderRoles="SAP_XMII_User" RestrictedPropertyOverride="false" RowCount="100" SaveDate="07/26/2024 14:45:04" Schedule="" SelectedColumns="" Server="MII_DB" Service="" SortExpr="" StartDate="" Tables="" Time="" TimePeriod="" Trace="false" UseTypedParams="false" UserName="" Version="15.0.4.2" WriterRoles="SAP_XMII_Super_Administrator,SAP_XMII_Administrator,SAP_XMII_Developer" XParamName.1="" XParamName.10="" XParamName.11="" XParamName.12="" XParamName.13="" XParamName.14="" XParamName.15="" XParamName.16="" XParamName.2="" XParamName.3="" XParamName.4="" XParamName.5="" XParamName.6="" XParamName.7="" XParamName.8="" XParamName.9="" XParamValue.1="" XParamValue.10="" XParamValue.11="" XParamValue.12="" XParamValue.13="" XParamValue.14="" XParamValue.15="" XParamValue.16="" XParamValue.2="" XParamValue.3="" XParamValue.4="" XParamValue.5="" XParamValue.6="" XParamValue.7="" XParamValue.8="" XParamValue.9=""><Tasks/><ETCServers/><ETCObjects/></SQLQuery>